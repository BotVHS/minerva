#!/bin/bash

# Pre-commit hook per executar tests abans de cada commit
# Per activar-lo:
#   chmod +x .git-hooks/pre-commit
#   git config core.hooksPath .git-hooks

echo "ğŸ§ª Executant tests abans de commit..."

cd backend

# Executar tests unitaris
echo "â–¶ Tests unitaris..."
./mvnw test -Dtest="*Test" -q

if [ $? -ne 0 ]; then
    echo "âŒ Tests unitaris fallits! Commit cancelÂ·lat."
    echo "ğŸ’¡ Solucions:"
    echo "   - Revisa els errors i arregla'ls"
    echo "   - O executa: git commit --no-verify (NO recomanat)"
    exit 1
fi

# Executar tests de seguretat
echo "â–¶ Tests de seguretat..."
./mvnw test -Dtest=SecurityTest -q

if [ $? -ne 0 ]; then
    echo "âŒ Tests de seguretat fallits! Commit cancelÂ·lat."
    echo "âš ï¸  CRÃTICA DE SEGURETAT - Arregla immediatament!"
    exit 1
fi

# Verificar code coverage
echo "â–¶ Verificant code coverage (mÃ­nim 70%)..."
./mvnw jacoco:check -q

if [ $? -ne 0 ]; then
    echo "âš ï¸  Code coverage inferior al 70%!"
    echo "ğŸ’¡ Executa: mvn jacoco:report i revisa target/site/jacoco/index.html"
    echo "   Pots fer commit igualment, perÃ² afegeix mÃ©s tests aviat."
    # No bloquejar commit per coverage baix (nomÃ©s warning)
fi

echo "âœ… Tots els tests passen!"
echo "ğŸ“Š Pots revisar coverage a: backend/target/site/jacoco/index.html"
exit 0
